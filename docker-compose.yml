name: memu-suite

# =============================================================================
# Memu: Family Digital Infrastructure
# =============================================================================
# This stack runs: Chat (Matrix), Photos (Immich), AI (Ollama)
#
# SECURITY MODEL:
# - All services communicate via internal Docker network (memu_net)
# - Only the Nginx proxy (port 80) is exposed to external networks
# - Backend services are bound to 127.0.0.1 for debugging only
# - Remote access is via Tailscale (encrypted, authenticated)
#
# Access paths:
#   Local:     http://localhost or http://memu.local
#   Remote:    http://memu-hub (via Tailscale)
#   Photos:    http://localhost/photos or http://memu-hub:2283
# =============================================================================

services:
  # === CORE INFRASTRUCTURE ===

  database:
    container_name: memu_postgres
    image: tensorchord/pgvecto-rs:pg15-v0.2.0
    environment:
      POSTGRES_DB: ${DB_NAME:-immich}
      POSTGRES_USER: ${DB_USER:-memu_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_INITDB_ARGS: --encoding=UTF8 --lc-collate=C --lc-ctype=C
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${DB_USER:-memu_user} -d ${DB_NAME:-immich}" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    volumes:
      - pgdata:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - memu_net
    # NOTE: No ports exposed - database is internal only

  cache:
    container_name: memu_redis
    image: redis:6.2-alpine
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "redis-cli ping || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 3
    volumes:
      - redisdata:/data
    networks:
      - memu_net
    # NOTE: No ports exposed - cache is internal only

    # === ADMIN / BOOTSTRAP SERVICE ===
    # This runs the Setup Wizard and Admin Dashboard (app.py)
  bootstrap:
    container_name: memu_bootstrap
    build:
      context: ./bootstrap
      dockerfile: Dockerfile
    volumes:
      # Mount code so edits are reflected (optional, but good for dev)
      - ./bootstrap:/app
      # Mount Docker socket so it can control other containers
      - /var/run/docker.sock:/var/run/docker.sock
      # Mount project root to write config files (homeserver.yaml, etc)
      - ./:/data_root
    environment:
      - WIZARD_PORT=8888
      - PROJECT_ROOT=/data_root
      - FLASK_ENV=production
    networks:
      - memu_net
    # No external port - nginx proxies to bootstrap:8888 via Docker network.
    # During initial setup, the systemd service runs Flask on the host.
    restart: unless-stopped
    # === CHAT SERVICES ===

  synapse:
    container_name: memu_synapse
    # Updated from v1.98.0 to recent stable
    image: matrixdotorg/synapse:latest
    volumes:
      - ./synapse:/data
    environment:
      - SYNAPSE_SERVER_NAME=${SERVER_NAME:-memu.local}
      - SYNAPSE_REPORT_STATS=no
    depends_on:
      database:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8008/_matrix/client/versions" ]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - memu_net
    # SECURITY: Port removed - access via Nginx proxy only
    # For local debugging: uncomment the line below
    # SECURITY: Accessible via Tailscale
    ports:
      - "8008:8008"

  element:
    container_name: memu_element
    # Cinny: lightweight Matrix client (Element v1.11.85 has WidgetStore crash)
    image: ghcr.io/cinnyapp/cinny:v4.2.3
    volumes:
      - ./element-config.json:/app/config.json:ro
    restart: unless-stopped
    networks:
      - memu_net
    # SECURITY: Accessible via Tailscale
    ports:
      - "8080:80"
    # === PHOTO SERVICES (IMMICH) ===

  immich_server:
    container_name: memu_photos
    # Updated to recent stable
    image: ghcr.io/immich-app/immich-server:v1.124.0
    # command: [ "start.sh", "immich" ] # Deprecated, using default
    restart: unless-stopped
    volumes:
      - ${UPLOAD_LOCATION:-./photos}:/usr/src/app/upload
      - /etc/localtime:/etc/localtime:ro
    environment:
      - DB_HOSTNAME=database
      - DB_USERNAME=${DB_USER:-memu_user}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_DATABASE_NAME=${DB_NAME:-immich}
      - REDIS_HOSTNAME=cache
    depends_on:
      database:
        condition: service_healthy
      cache:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:2283/api/server/ping" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - memu_net
    # SECURITY: Accessible via Tailscale
    # Access via Tailscale: http://memu-hub:2283
    # This port IS needed for Immich mobile apps to connect
    ports:
      - "2283:2283"

  # immich_workers:
  #   container_name: memu_photos_workers
  #   # Updated to match immich_server version
  #   image: ghcr.io/immich-app/immich-server:v1.124.0
  #   command: [ "start.sh", "microservices" ]
  #   restart: unless-stopped
  #   volumes:
  #     - ${UPLOAD_LOCATION:-./photos}:/usr/src/app/upload
  #     - /etc/localtime:/etc/localtime:ro
  #   environment:
  #     - DB_HOSTNAME=database
  #     - DB_USERNAME=${DB_USER:-memu_user}
  #     - DB_PASSWORD=${DB_PASSWORD}
  #     - DB_DATABASE_NAME=${DB_NAME:-immich}
  #     - REDIS_HOSTNAME=cache
  #   depends_on:
  #     database:
  #       condition: service_healthy
  #     cache:
  #       condition: service_healthy
  #   networks:
  #     - memu_net
  #   # NOTE: No ports - workers are internal only

  immich_ml:
    container_name: memu_photos_ml
    # Updated to match immich_server version
    image: ghcr.io/immich-app/immich-machine-learning:v1.124.0
    volumes:
      - model_cache:/cache
    environment:
      - MACHINE_LEARNING_WORKERS=${MACHINE_LEARNING_WORKERS:-1}
      - MACHINE_LEARNING_WORKER_TIMEOUT=${MACHINE_LEARNING_WORKER_TIMEOUT:-120}
    restart: unless-stopped
    networks:
      - memu_net
    # NOTE: No ports - ML service is internal only

    # === AI SERVICES ===

  ollama:
    container_name: memu_brain
    # Updated from 0.1.27 to recent stable
    image: ollama/ollama:latest
    restart: unless-stopped
    volumes:
      - ollama_data:/root/.ollama
    environment:
      - OLLAMA_KEEP_ALIVE=24h
    networks:
      - memu_net
    # SECURITY: Bound to localhost only - not accessible from public internet
    # The intelligence service connects via internal Docker network
    # SECURITY: Accessible via Tailscale
    ports:
      - "11434:11434"

  intelligence:
    container_name: memu_intelligence
    build:
      context: ./services/intelligence
      dockerfile: Dockerfile
    environment:
      - DB_HOST=database
      - DB_NAME=${DB_NAME:-immich}
      - DB_USER=${DB_USER:-memu_user}
      - DB_PASSWORD=${DB_PASSWORD}
      - OLLAMA_HOST=http://ollama:11434
      - AI_ENABLED=${AI_ENABLED:-true}
      - MATRIX_HOMESERVER_URL=http://synapse:8008
      - MATRIX_BOT_TOKEN=${MATRIX_BOT_TOKEN}
      - MATRIX_BOT_USERNAME=${MATRIX_BOT_USERNAME}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3.2}
      - CALDAV_URL=http://calendar/dav.php
      - CALDAV_USERNAME=${CALDAV_USERNAME:-memu}
      - CALDAV_PASSWORD=${CALDAV_PASSWORD:-}
      - TIMEZONE=${TIMEZONE:-Europe/London}
      - BRIEFING_ENABLED=${BRIEFING_ENABLED:-true}
      - BRIEFING_TIME=${BRIEFING_TIME:-07:00}
      - PRIMARY_ROOM_ID=${PRIMARY_ROOM_ID:-}
      - WEATHER_API_KEY=${WEATHER_API_KEY:-}
      - WEATHER_CITY=${WEATHER_CITY:-London}
      - WEATHER_COUNTRY=${WEATHER_COUNTRY:-UK}
      - IMMICH_API_URL=http://immich_server:2283
      - IMMICH_API_KEY=${IMMICH_API_KEY:-}
    depends_on:
      database:
        condition: service_healthy
      synapse:
        condition: service_healthy
      calendar:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - memu_net
    # NOTE: No ports - bot communicates via Matrix protocol

    # === CALENDAR SERVICE (BAIKAL) ===

  calendar:
    container_name: memu_calendar
    image: ckulka/baikal:0.9.5-apache
    restart: unless-stopped
    volumes:
      - baikal_config:/var/www/baikal/config
      - baikal_data:/var/www/baikal/Specific
    environment:
      - TZ=${TIMEZONE:-Europe/London}
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - memu_net
    # NOTE: No ports exposed - accessible via Nginx proxy only

    # === NETWORK (TAILSCALE) ===

  tailscale:
    container_name: memu_tailscale
    image: tailscale/tailscale:latest
    hostname: memu-hub
    environment:
      - TS_AUTHKEY=${TAILSCALE_AUTH_KEY}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
      - TS_EXTRA_ARGS=--accept-dns=true
    volumes:
      - tailscale_data:/var/lib/tailscale
      - tls_certs:/certs
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - NET_RAW
    restart: unless-stopped
    network_mode: host
    # NOTE: Tailscale creates its own encrypted tunnel - no ports needed
    # TODO (v1.0): Consider using Docker secrets for TS_AUTHKEY

    # === ROUTING (NGINX) ===

  proxy:
    container_name: memu_proxy
    image: nginx:1.27-alpine
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./assets:/usr/share/nginx/assets:ro
      - tls_certs:/etc/nginx/certs:ro
    depends_on:
      - element
      - synapse
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost/" ]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - memu_net
    # SECURITY: This is the ONLY externally accessible port
    # All HTTP traffic enters through Nginx and is routed internally
    ports:
      - "80:80"
      - "443:443"

networks:
  memu_net:
    driver: bridge

volumes:
  pgdata:
  redisdata:
  model_cache:
  ollama_data:
  tailscale_data:
  baikal_config:
  baikal_data:
  tls_certs:


